/**
 * üç™ GESTIONNAIRE DE COOKIES RGPD COMPLET
 * Conforme aux exigences RGPD pour GasyWay
 */

// D√©clarations TypeScript pour les services externes
declare global {
  interface Window {
    dataLayer: any[];
    fbq: (...args: any[]) => void;
    gtag: (...args: any[]) => void;
  }
}

export interface CookiePreferences {
  necessary: boolean;
  analytics: boolean;
  marketing: boolean;
  preferences: boolean;
  timestamp?: string;
}

const STORAGE_KEY = 'gasyway-cookie-consent';
const COOKIE_EXPIRY_DAYS = 365;

/**
 * üìù DOCUMENTATION DES COOKIES UTILIS√âS
 */
export const COOKIE_CATALOG = {
  necessary: [
    {
      name: 'gasyway-auth-token',
      purpose: 'Token d\'authentification utilisateur',
      duration: '24h',
      provider: 'GasyWay'
    },
    {
      name: 'gasyway-session',
      purpose: 'Session utilisateur',
      duration: 'Session',
      provider: 'GasyWay'
    },
    {
      name: 'gasyway-cookie-consent',
      purpose: 'Pr√©f√©rences de cookies',
      duration: '365 jours',
      provider: 'GasyWay'
    }
  ],
  analytics: [
    {
      name: '_ga',
      purpose: 'Google Analytics - Identifiant unique',
      duration: '2 ans',
      provider: 'Google'
    },
    {
      name: '_ga_*',
      purpose: 'Google Analytics - Sessions',
      duration: '2 ans',
      provider: 'Google'
    },
    {
      name: 'gasyway-analytics',
      purpose: 'Statistiques internes',
      duration: '30 jours',
      provider: 'GasyWay'
    }
  ],
  marketing: [
    {
      name: '_fbp',
      purpose: 'Facebook Pixel',
      duration: '90 jours',
      provider: 'Facebook'
    },
    {
      name: 'gasyway-marketing',
      purpose: 'Pr√©f√©rences publicitaires',
      duration: '180 jours',
      provider: 'GasyWay'
    }
  ],
  preferences: [
    {
      name: 'gasyway-theme',
      purpose: 'Th√®me d\'affichage',
      duration: '365 jours',
      provider: 'GasyWay'
    },
    {
      name: 'gasyway-language',
      purpose: 'Pr√©f√©rence de langue',
      duration: '365 jours',
      provider: 'GasyWay'
    },
    {
      name: 'gasyway-region',
      purpose: 'R√©gion pr√©f√©r√©e',
      duration: '365 jours',
      provider: 'GasyWay'
    }
  ]
};

/**
 * üîç OBTENIR LES PR√âF√âRENCES ACTUELLES
 */
export function getCookiePreferences(): CookiePreferences | null {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return null;
    
    const parsed = JSON.parse(stored);
    
    // V√©rifier si les pr√©f√©rences ont expir√©
    if (parsed.timestamp) {
      const stored = new Date(parsed.timestamp);
      const now = new Date();
      const diffDays = (now.getTime() - stored.getTime()) / (1000 * 60 * 60 * 24);
      
      if (diffDays > COOKIE_EXPIRY_DAYS) {
        localStorage.removeItem(STORAGE_KEY);
        return null;
      }
    }
    
    return {
      necessary: true, // Toujours true
      analytics: parsed.analytics || false,
      marketing: parsed.marketing || false,
      preferences: parsed.preferences || false,
      timestamp: parsed.timestamp
    };
  } catch (error) {
    console.error('Erreur lecture pr√©f√©rences cookies:', error);
    return null;
  }
}

/**
 * üíæ SAUVEGARDER LES PR√âF√âRENCES
 */
export function saveCookiePreferences(preferences: CookiePreferences): void {
  try {
    const toSave = {
      ...preferences,
      necessary: true, // Forcer √† true
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    
    // D√©clencher l'√©v√©nement pour notifier l'app
    window.dispatchEvent(new CustomEvent('cookie-consent-updated', {
      detail: toSave
    }));
    
    console.log('üç™ Pr√©f√©rences cookies sauvegard√©es:', toSave);
  } catch (error) {
    console.error('Erreur sauvegarde pr√©f√©rences cookies:', error);
  }
}

/**
 * üö´ SUPPRIMER LES COOKIES NON AUTORIS√âS
 */
export function enforceConsent(): void {
  console.log('üîß Mode d√©veloppement - Enforcement cookies d√©sactiv√©');
  return; // TEMPORAIREMENT D√âSACTIV√â
  
  const preferences = getCookiePreferences();
  if (!preferences) return;
  
  // Supprimer les cookies analytics si non autoris√©s
  if (!preferences.analytics) {
    deleteCookiesByCategory('analytics');
  }
  
  // Supprimer les cookies marketing si non autoris√©s
  if (!preferences.marketing) {
    deleteCookiesByCategory('marketing');
  }
  
  // Supprimer les cookies de pr√©f√©rences si non autoris√©s
  if (!preferences.preferences) {
    deleteCookiesByCategory('preferences');
  }
}

/**
 * üóëÔ∏è SUPPRIMER LES COOKIES PAR CAT√âGORIE
 */
function deleteCookiesByCategory(category: keyof typeof COOKIE_CATALOG): void {
  const cookies = COOKIE_CATALOG[category];
  
  cookies.forEach(cookie => {
    // Supprimer le cookie
    document.cookie = `${cookie.name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
    document.cookie = `${cookie.name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.${window.location.hostname};`;
    
    // Supprimer du localStorage si applicable
    if (cookie.name.startsWith('gasyway-')) {
      localStorage.removeItem(cookie.name);
      sessionStorage.removeItem(cookie.name);
    }
  });
  
  console.log(`üóëÔ∏è Cookies ${category} supprim√©s`);
}

/**
 * ‚úÖ V√âRIFIER SI UN TYPE DE COOKIE EST AUTORIS√â
 */
export function isCookieTypeAllowed(type: keyof CookiePreferences): boolean {
  const preferences = getCookiePreferences();
  if (!preferences) return false;
  
  return preferences[type] === true;
}

/**
 * üîÑ R√âINITIALISER LE CONSENTEMENT
 */
export function resetConsent(): void {
  localStorage.removeItem(STORAGE_KEY);
  
  // Supprimer tous les cookies optionnels
  deleteCookiesByCategory('analytics');
  deleteCookiesByCategory('marketing');
  deleteCookiesByCategory('preferences');
  
  // D√©clencher l'√©v√©nement de r√©initialisation
  window.dispatchEvent(new CustomEvent('reset-cookie-consent'));
  
  console.log('üîÑ Consentement cookies r√©initialis√©');
}

/**
 * üìä ANALYTICS - GOOGLE ANALYTICS
 */
export function initGoogleAnalytics(): void {
  try {
    if (!isCookieTypeAllowed('analytics')) return;
    
    // Lire l'ID depuis les variables d'environnement
    let GA_ID = 'G-XXXXXXXXXX';
    try {
      GA_ID = import.meta.env?.VITE_GOOGLE_ANALYTICS_ID || 'G-XXXXXXXXXX';
    } catch (error) {
      console.warn('‚ö†Ô∏è Variables d\'environnement non disponibles');
    }
    
    // V√©rifier que l'ID est configur√©
    if (GA_ID === 'G-XXXXXXXXXX') {
      console.warn('‚ö†Ô∏è Google Analytics ID non configur√©. Ajoutez VITE_GOOGLE_ANALYTICS_ID dans vos variables d\'environnement.');
      return;
    }
  
  // Charger Google Analytics
  const script = document.createElement('script');
  script.async = true;
  script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
  document.head.appendChild(script);
  
  // Configuration GA
  window.dataLayer = window.dataLayer || [];
  function gtag(...args: any[]) {
    window.dataLayer.push(args);
  }
  
  gtag('js', new Date());
  gtag('config', GA_ID, {
    anonymize_ip: true,
    cookie_expires: 63072000 // 2 ans
  });
  
  console.log(`üìä Google Analytics initialis√© avec ID: ${GA_ID}`);
  } catch (error) {
    console.warn('‚ö†Ô∏è Erreur lors de l\'initialisation de Google Analytics:', error);
  }
}

/**
 * üì± MARKETING - FACEBOOK PIXEL
 */
export function initFacebookPixel(): void {
  try {
    if (!isCookieTypeAllowed('marketing')) return;
    
    // Lire l'ID depuis les variables d'environnement
    let PIXEL_ID = 'XXXXXXXXXXXXXXX';
    try {
      PIXEL_ID = import.meta.env?.VITE_FACEBOOK_PIXEL_ID || 'XXXXXXXXXXXXXXX';
    } catch (error) {
      console.warn('‚ö†Ô∏è Variables d\'environnement non disponibles');
    }
    
    // V√©rifier que l'ID est configur√©
    if (PIXEL_ID === 'XXXXXXXXXXXXXXX') {
      console.warn('‚ö†Ô∏è Facebook Pixel ID non configur√©. Ajoutez VITE_FACEBOOK_PIXEL_ID dans vos variables d\'environnement.');
      return;
    }
    
    // Code Facebook Pixel
    !function(f: any, b: any, e: any, v: any, n?: any, t?: any, s?: any) {
      if(f.fbq) return;
      n = f.fbq = function() {
        n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments);
      };
      if(!f._fbq) f._fbq = n;
      n.push = n;
      n.loaded = !0;
      n.version = '2.0';
      n.queue = [];
      t = b.createElement(e);
      t.async = !0;
      t.src = v;
      s = b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t, s);
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
    
    window.fbq('init', PIXEL_ID);
    window.fbq('track', 'PageView');
    
    console.log(`üì± Facebook Pixel initialis√© avec ID: ${PIXEL_ID}`);
  } catch (error) {
    console.warn('‚ö†Ô∏è Erreur lors de l\'initialisation de Facebook Pixel:', error);
  }
}

/**
 * üéØ INITIALISER TOUS LES SERVICES SELON PR√âF√âRENCES
 */
export function initializeConsentedServices(): void {
  console.log('üîß Mode d√©veloppement - Services cookies d√©sactiv√©s');
  return; // TEMPORAIREMENT D√âSACTIV√â
  
  try {
    const preferences = getCookiePreferences();
    if (!preferences) return;
    
    if (preferences.analytics) {
      initGoogleAnalytics();
    }
    
    if (preferences.marketing) {
      initFacebookPixel();
    }
    
    if (preferences.preferences) {
      // Charger les pr√©f√©rences utilisateur sauvegard√©es
      loadUserPreferences();
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Erreur lors de l\'initialisation des services cookies:', error);
  }
  
  console.log('üéØ Services initialis√©s selon consentement:', preferences);
}

/**
 * üíæ CHARGER LES PR√âF√âRENCES UTILISATEUR
 */
function loadUserPreferences(): void {
  try {
    const theme = localStorage.getItem('gasyway-theme');
    if (theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }
    
    const language = localStorage.getItem('gasyway-language');
    if (language) {
      document.documentElement.setAttribute('lang', language);
    }
    
    console.log('üíæ Pr√©f√©rences utilisateur charg√©es');
  } catch (error) {
    console.error('Erreur chargement pr√©f√©rences:', error);
  }
}

/**
 * üìã OBTENIR LA LISTE COMPL√àTE DES COOKIES POUR LA DOCUMENTATION
 */
export function getAllCookiesDocumentation() {
  return COOKIE_CATALOG;
}

// D√©clarations TypeScript pour les services externes
declare global {
  interface Window {
    dataLayer: any[];
    gtag: (...args: any[]) => void;
    fbq: (...args: any[]) => void;
    _fbq: any;
  }
}